<html>
    <head>
        <title>Booking</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="../styles/booking.css">
        <link rel="icon" href="https://bikeshare.metro.net/wp-content/uploads/2016/04/cropped-metro-bike-share-favicon-1-300x300.png" />
    </head>
    <body>
        <div class="header-container"></div>
        <div class="content">
            <form>
                <h1>Book your bycicle</h1>
            <fieldset>
                <legend>
                    <span class="number">1</span> 
                    Your basic information
                </legend>
                <label for="name">Name *</label>
                <input maxlength="20" type="text" id="name" name="name">
            
                <label for="surname">Surname *</label>
                <input maxlength="30" type="text" id="surname" name="surname">
            
                <label for="email">Email *</label>
                <input maxlength="50" type="email" id="email" name="email">
            
                <label for="phone">Phone:</label>
                <input maxlength="16" type="tel" id="phone" name="phone">
            </fieldset>
            <fieldset>  
                <legend><span class="number">2</span>Dates</legend>
                
                <label for="startDate">Start date:</label>
                <input type="date" id="startDate" name="startDate">
                
                <label for="endDate">End date:</label>
                <input type="date" id="endDate" name="endDate">  
            </fieldset>
            <fieldset>
                <legend><span class="number">3</span>Price</legend>
                <p id="price">Please, select the dates and price will be shown</p>
                <span id="error"></span>
            </fieldset>
                <button type="button" onclick="validateRequest()">Book now!</button>    
            </form>
        </div>
    </body>
    <script src="../components/header.js"></script>
    <script src="../utils/Utils.js"></script>
    <script src="../services/BookingService.js"></script>
    <script>
        window.addEventListener("load", async () => {
            document.querySelector(".header-container").innerHTML = headerComponent.fillTemplateDefault();
            document.querySelector("#startDate").setAttribute("min", new Date().toISOString().split("T")[0]);
            document.querySelector("#endDate").setAttribute("min", new Date().toISOString().split("T")[0]);
            document.querySelector("#startDate").addEventListener("change", calculatePrice);
            document.querySelector("#endDate").addEventListener("change", calculatePrice);
        });

        function validateRequest() {
            let name = document.getElementById("name").value;
            let surname = document.getElementById("surname").value;
            let email = document.getElementById("email").value;
            let phone = document.getElementById("phone").value;
            let startDate = document.getElementById("startDate").value;
            let endDate = document.getElementById("endDate").value;
            
            let values = [name, surname, email, startDate, endDate];
            for (let i = 0; i < values.length; i++) {
                if (values[i] == "") {
                    document.getElementById("error").innerHTML = "Please fill all the compulsory fields";
                    return;
                }
            }

            let total = calculateTotal(startDate, endDate, utils.getUrlParam("price"));
            createBooking(name, surname, email, phone, startDate, endDate, utils.getUrlParam("bycicleId"), utils.getUrlParam("storeId"), total);
        }

        function calculatePrice () {
            let startDate = document.getElementById("startDate").value;
            let endDate = document.getElementById("endDate").value;
            let price = utils.getUrlParam("price");

            if (!checkDatesAreCorrect(startDate, endDate)) {
                document.getElementById("price").innerHTML = ``;
                return;
            } else {
                let total = calculateTotal(startDate, endDate, price);
                document.getElementById("price").innerHTML = `Total: ${total.toFixed(2)} â‚¬`;
            }
        }

        function checkDatesAreCorrect(startDate, endDate) {
            if (startDate === "" || endDate === "") {
                return false;
            } else if (startDate > endDate) {
                document.getElementById("error").innerHTML = "Start date must be before end date";
                return false;
            } else if (startDate === endDate) {
                document.getElementById("error").innerHTML = "Start date must be different from end date";
                return false;
            } else if (startDate < new Date().toISOString().split("T")[0]) {
                document.getElementById("error").innerHTML = "Start date must be after today";
                return false;
            } else if (endDate < new Date().toISOString().split("T")[0]) {
                document.getElementById("error").innerHTML = "End date must be after today";
                return false;
            } else {
                document.getElementById("error").innerHTML = "";
            }
            return true;
        }

        function calculateTotal(startDate, endDate, price) {
            let start = new Date(startDate);
            let end = new Date(endDate);
            let diff = end.getTime() - start.getTime();
            let days = diff / (1000 * 3600 * 24);
            return days * price;
        }

        function createBooking(name, surname, email, phone, startDate, endDate, bycicleId, storeId, total) {
            let booking = {
                name: name,
                surname: surname,
                email: email,
                phoneNumber: phone,
                bycicleId: parseInt(bycicleId),
                storeId: parseInt(storeId),
                startDate: startDate,
                endDate: endDate,
                total: total
            };

            bookingService.registerBooking(booking)
                .then((response) => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then((data) => {
                    let booking = data;
                    window.location = `./confirmation.html?bookingId=${booking.publicId}`;
                })
        }
    </script>
</html>