<html>
  <head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../styles/availability.css" />
    <link rel="icon" href="https://bikeshare.metro.net/wp-content/uploads/2016/04/cropped-metro-bike-share-favicon-1-300x300.png" />
    <title>Home</title>
  </head>
  <body>
    <div class="container">
      <div class="header-container"></div>
      <div class="content"></div>
      <div class="pagination">
        <div id="previous">
          <button class="effect arrowLeft" onclick="previousPage()">Previous</button>
        </div>
        <p id="pageIndicator"></p>
        <div id="next">
          <button class="effect arrowRight" onclick="nextPage()">Next</button>
        </div>
      </div>
    </div>
  </body>
  <script src="../services/AvailabilityService.js"></script>
  <script src="../components/card.js"></script>
  <script src="../components/header.js"></script>
  <script src="../utils/Utils.js"></script>
  <script>
    window.addEventListener("load", async () => {
      this.availabilities = [];
      this.pagination = 3;
      this.currentPage = 1;
      this.maxPage = 0;
      this.availableFilters = ["category"];

      document.querySelector(".header-container").innerHTML = headerComponent.fillTemplateDefault();

      availabilityService
        .getAvailability()
        .then((response) => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then((data) => {

          if (areFiltersOn()) {
            let paramNames = utils.getParamNames(this.availableFilters);
            paramNames.forEach((param) => {
              data = filterData(data, param, utils.getUrlParam(param));
            })
          }

          data.forEach((availability) => {
            this.availabilities.push(availability);
          });

          this.maxPage = Math.ceil(this.availabilities.length / this.pagination);
          let cards = cardComponent.fillTemplate(this.availabilities.slice(0, this.pagination));

          cards.forEach((card) => {
            document.querySelector(".content").innerHTML += card;
          });

          document.querySelector("#pageIndicator").innerHTML = this.currentPage + "/" + this.maxPage;
        })
        .catch((error) => {
          noAvailability();
          console.log(error);
        });
    });

    function nextPage() {
      if (this.currentPage < this.maxPage) {
        this.currentPage++;
        document.querySelector(".content").innerHTML = "";
        document.querySelector("#pageIndicator").innerHTML = this.currentPage + "/" + this.maxPage;

        let cards = cardComponent.fillTemplate(
          this.availabilities.slice((this.currentPage - 1) * this.pagination, this.currentPage * this.pagination)
        );
        cards.forEach((card) => {
          document.querySelector(".content").innerHTML += card;
        });
      } 
    }

    function previousPage() {
      if (this.currentPage > 1) {
        this.currentPage--;
        document.querySelector(".content").innerHTML = "";
        document.querySelector("#pageIndicator").innerHTML = this.currentPage + "/" + this.maxPage;

        let cards = cardComponent.fillTemplate(
          this.availabilities.slice((this.currentPage - 1) * this.pagination, this.currentPage * this.pagination)
        );
        cards.forEach((card) => {
          document.querySelector(".content").innerHTML += card;
        });
      }
    }
    
    function removeFilters() {
      window.location.href = "./index.html";
    }

    function noAvailability() {
      document.querySelector(".content").innerHTML = `<h1 class="availabilityNotFound" >Sorry, we are not able to show you the availabilities at the moment. Please try again later.</h1>`;
      document.querySelector(".pagination").innerHTML = "";
    }

    /**
      * @param {Array} data
      * @param {String} filteredProperty
      * @param {String} filterValue
      */
    function filterData(data, filteredProperty, filterValue) {
      let dataNames = data.length > 0 ? Object.getOwnPropertyNames(data[0].bycicle) : [];

      for (let i = 0; i < dataNames.length; i++) {
        if (dataNames[i] == filteredProperty) {
          document.querySelector(".pagination").innerHTML += `<button class="effect" onclick="removeFilters()">Remove filters</button>`;
          return data.filter((availability) => availability.bycicle[filteredProperty] === filterValue);
        }
      };
    }

    function areFiltersOn() {
      for (let i = 0; i < this.availableFilters.length; i++) {
        if (utils.getUrlParam(this.availableFilters[i])) {
          return true;
        }
      }
      return false;
    }
  </script>
</html>
