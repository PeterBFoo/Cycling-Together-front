<html>
    <head>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="../styles/confirmation.css" />
        <link rel="icon" href="https://bikeshare.metro.net/wp-content/uploads/2016/04/cropped-metro-bike-share-favicon-1-300x300.png" />
        <title>Confirmation</title>
    </head>
    <body>
        <div class="content">
            <div class="column">
                <img height="50" width="50" src="https://cdns.iconmonstr.com/wp-content/releases/preview/2018/240/iconmonstr-check-mark-circle-thin.png" alt="Confirmation" />
                <h1>Booking confirmed!</h1>
                <p>Thank you so much for booking with us, here are some of your details of your booking.</p>
                <p id="fillableBookingIdText"></p>
                <div class="divider"></div>
                <div id="bookingDetails" class="bookingDetails"></div>
                <nav class="links">
                    <a href="./index.html"><button class="effect arrow">Home</button></a>
                    <button class="effect print" onclick="window.print()">Print</button>
                    <div id="cancelBooking">
                        <button class="effect cancel" onclick="cancelBooking()">Cancel</button>
                    </div>
                </nav>
        </div>
    </body>
    <script src="../utils/Utils.js"></script>
    <script src="../services/BookingService.js"></script>
    <script>
        window.addEventListener("load", async () => {            
            document.getElementById("fillableBookingIdText").innerHTML = `Your booking ID is: <strong>${utils.getUrlParam("bookingId")}</strong>, please keep it for future reference. You can consult your booking details in the "My Booking" section.`;

            bookingService.getBooking(utils.getUrlParam("bookingId"))
            .then((response) => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(booking => {
                printBookingDetails(booking);
            });
        });

        function printBookingDetails(booking) {
            let bookingDetailsContainer = document.getElementById("bookingDetails");
                if (!booking.canceled) {
                    document.getElementById("cancelBooking").hidden = false;
                    let startDate = new Date(booking.startDate);
                    let endDate = new Date(booking.endDate);
    
                    bookingDetailsContainer.innerHTML = `
                        <h2>Booking details</h2>
                        <p><strong>Name</strong>: ${booking.name}</p>
                        <p><strong>Surname</strong>: ${booking.surname}</p>
                    `;

                    if (booking.email) {
                        bookingDetailsContainer.innerHTML += `<p><strong>Email</strong>: ${booking.email}</p>`;
                    }

                    if (booking.phoneNumber) {
                        bookingDetailsContainer.innerHTML += `<p><strong>Phone</strong>: ${booking.phoneNumber}</p>`;
                    }

                    bookingDetailsContainer.innerHTML += `
                        <p><strong>Start date</strong>: ${startDate.toLocaleDateString()}</p>
                        <p><strong>End date</strong>: ${endDate.toLocaleDateString()}</p>
                        <p><strong>Price</strong>: ${booking.total.toFixed(2)}â‚¬</p>
                    `;
                } else {
                    document.getElementById("cancelBooking").hidden = true;
                    bookingDetailsContainer.innerHTML = `
                        <h2>Booking details</h2>
                        <p>Your booking with ID <strong>${booking.publicId}</strong> is canceled. Thank you so much, dear customer</p>
                    `;
                }
        }

        function cancelBooking() {
            bookingService.cancelBooking(utils.getUrlParam("bookingId"))
            .then((response) => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(booking => {
                window.location.reload();
            });
        }
    </script>
</html>